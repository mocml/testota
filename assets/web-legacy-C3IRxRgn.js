System.register(["./index-legacy-ZkvQsxfg.js"],(function(e,o){"use strict";var t;return{setters:[e=>{t=e.W}],execute:function(){class o extends t{constructor(){super()}parseJwt(e){const o=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),t=decodeURIComponent(atob(o).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""));return JSON.parse(t)}async loadScript(e){return new Promise(((o,t)=>{const i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>{o()},i.onerror=t,document.body.appendChild(i)}))}}o.OAUTH_STATE_KEY="social_login_oauth_pending";class i extends o{constructor(){super(...arguments),this.clientId=null,this.redirectUrl=null,this.scriptLoaded=!1,this.scriptUrl="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"}async initialize(e,o){this.clientId=e,this.redirectUrl=o||null,e&&await this.loadAppleScript()}async login(e){if(!this.clientId)throw new Error("Apple Client ID not set. Call initialize() first.");if(!this.scriptLoaded)throw new Error("Apple Sign-In script not loaded.");return new Promise(((o,t)=>{var i;AppleID.auth.init({clientId:this.clientId,scope:(null===(i=e.scopes)||void 0===i?void 0:i.join(" "))||"name email",redirectURI:this.redirectUrl||window.location.href,state:e.state,nonce:e.nonce,usePopup:!0}),AppleID.auth.signIn().then((e=>{var t,i,n,r,s;const a={profile:{user:e.user||"",email:(null===(t=e.user)||void 0===t?void 0:t.email)||null,givenName:(null===(n=null===(i=e.user)||void 0===i?void 0:i.name)||void 0===n?void 0:n.firstName)||null,familyName:(null===(s=null===(r=e.user)||void 0===r?void 0:r.name)||void 0===s?void 0:s.lastName)||null},accessToken:{token:e.authorization.id_token||""},idToken:e.authorization.code||null};o({provider:"apple",result:a})})).catch((e=>{t(e)}))}))}async logout(){console.log("Apple logout: Session should be managed on the client side")}async isLoggedIn(){return console.log("Apple login status should be managed on the client side"),{isLoggedIn:!1}}async getAuthorizationCode(){throw console.log("Apple authorization code should be stored during login"),new Error("Apple authorization code not available")}async refresh(){console.log("Apple refresh not available on web")}async loadAppleScript(){if(!this.scriptLoaded)return this.loadScript(this.scriptUrl).then((()=>{this.scriptLoaded=!0}))}}class n extends o{constructor(){super(...arguments),this.appId=null,this.scriptLoaded=!1}async initialize(e){this.appId=e,e&&(await this.loadFacebookScript(),FB.init({appId:this.appId,version:"v17.0",xfbml:!0,cookie:!0}))}async login(e){if(!this.appId)throw new Error("Facebook App ID not set. Call initialize() first.");return new Promise(((o,t)=>{FB.login((e=>{"connected"===e.status?FB.api("/me",{fields:"id,name,email,picture"},(t=>{var i,n;const r={accessToken:{token:e.authResponse.accessToken,userId:e.authResponse.userID},profile:{userID:t.id,name:t.name,email:t.email||null,imageURL:(null===(n=null===(i=t.picture)||void 0===i?void 0:i.data)||void 0===n?void 0:n.url)||null,friendIDs:[],birthday:null,ageRange:null,gender:null,location:null,hometown:null,profileURL:null},idToken:null};o({provider:"facebook",result:r})})):t(new Error("Facebook login failed"))}),{scope:e.permissions.join(",")})}))}async logout(){return new Promise((e=>{FB.logout((()=>e()))}))}async isLoggedIn(){return new Promise((e=>{FB.getLoginStatus((o=>{e({isLoggedIn:"connected"===o.status})}))}))}async getAuthorizationCode(){return new Promise(((e,o)=>{FB.getLoginStatus((t=>{var i;"connected"===t.status?e({jwt:(null===(i=t.authResponse)||void 0===i?void 0:i.accessToken)||""}):o(new Error("No Facebook authorization code available"))}))}))}async refresh(e){await this.login(e)}async loadFacebookScript(){if(!this.scriptLoaded)return this.loadScript("https://connect.facebook.net/en_US/sdk.js").then((()=>{this.scriptLoaded=!0}))}}class r extends o{constructor(){super(...arguments),this.clientId=null,this.loginType="online",this.GOOGLE_TOKEN_REQUEST_URL="https://www.googleapis.com/oauth2/v3/tokeninfo",this.GOOGLE_STATE_KEY="capgo_social_login_google_state"}async initialize(e,o,t,i){this.clientId=e,o&&(this.loginType=o),this.hostedDomain=t,this.redirectUrl=i}async login(e){if(!this.clientId)throw new Error("Google Client ID not set. Call initialize() first.");let o=e.scopes||[];o.length>0?(o.includes("https://www.googleapis.com/auth/userinfo.email")||o.push("https://www.googleapis.com/auth/userinfo.email"),o.includes("https://www.googleapis.com/auth/userinfo.profile")||o.push("https://www.googleapis.com/auth/userinfo.profile"),o.includes("openid")||o.push("openid")):o=["https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/userinfo.profile","openid"];const t=e.nonce||Math.random().toString(36).substring(2);return this.traditionalOAuth({scopes:o,nonce:t,hostedDomain:this.hostedDomain})}async logout(){if("offline"===this.loginType)return Promise.reject("Offline login doesn't store tokens. logout is not available");const e=this.getGoogleState();e&&await this.rawLogoutGoogle(e.accessToken)}async isLoggedIn(){if("offline"===this.loginType)return Promise.reject("Offline login doesn't store tokens. isLoggedIn is not available");const e=this.getGoogleState();if(!e)return{isLoggedIn:!1};try{const t=await this.accessTokenIsValid(e.accessToken),i=this.idTokenValid(e.idToken);if(t&&i)return{isLoggedIn:!0};try{await this.rawLogoutGoogle(e.accessToken,!1)}catch(o){console.error("Access token is not valid, but cannot logout",o)}return{isLoggedIn:!1}}catch(o){return Promise.reject(o)}}async getAuthorizationCode(){if("offline"===this.loginType)return Promise.reject("Offline login doesn't store tokens. getAuthorizationCode is not available");const e=this.getGoogleState();if(!e)throw new Error("No Google authorization code available");try{const t=await this.accessTokenIsValid(e.accessToken),i=this.idTokenValid(e.idToken);if(t&&i)return{accessToken:e.accessToken,jwt:e.idToken};try{await this.rawLogoutGoogle(e.accessToken,!1)}catch(o){console.error("Access token is not valid, but cannot logout",o)}throw new Error("No Google authorization code available")}catch(o){return Promise.reject(o)}}async refresh(){return Promise.reject("Not implemented")}handleOAuthRedirect(e){const t=e.searchParams,i=t.get("code");if(i&&t.has("scope"))return{provider:"google",result:{serverAuthCode:i,responseType:"offline"}};const n=e.hash.substring(1);if(console.log("handleOAuthRedirect",e.hash),!n)return null;console.log("handleOAuthRedirect ok");const r=new URLSearchParams(n),s=r.get("access_token"),a=r.get("id_token");if(s&&a){localStorage.removeItem(o.OAUTH_STATE_KEY);const e=this.parseJwt(a);return{provider:"google",result:{accessToken:{token:s},idToken:a,profile:{email:e.email||null,familyName:e.family_name||null,givenName:e.given_name||null,id:e.sub||null,name:e.name||null,imageUrl:e.picture||null},responseType:"online"}}}return null}async accessTokenIsValid(e){const o=`${this.GOOGLE_TOKEN_REQUEST_URL}?access_token=${encodeURIComponent(e)}`;try{const e=await fetch(o);if(!e.ok)return console.log(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response not successful. Status code: ${e.status}. Assuming that the token is not valid`),!1;const i=await e.text();if(!i)throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is null`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is null`);let n;try{n=JSON.parse(i)}catch(t){throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is not valid JSON. Error: ${t}`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is not valid JSON. Error: ${t}`)}const r=n.expires_in;if(null==r)throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response JSON does not include 'expires_in'.`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response JSON does not include 'expires_in'.`);let s;try{if(s=parseInt(r,10),isNaN(s))throw new Error("'expires_in' is not a valid integer")}catch(t){throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. 'expires_in': ${r} is not a valid integer. Error: ${t}`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. 'expires_in': ${r} is not a valid integer. Error: ${t}`)}return s>5}catch(i){throw console.error(i),i}}idTokenValid(e){try{const o=this.parseJwt(e),t=Math.ceil(Date.now()/1e3)+5;return o.exp&&t<o.exp}catch(o){return!1}}async rawLogoutGoogle(e,o=null){if(null===o&&(o=await this.accessTokenIsValid(e)),!0!==o)this.clearStateGoogle();else try{await fetch(`https://accounts.google.com/o/oauth2/revoke?token=${encodeURIComponent(e)}`),this.clearStateGoogle()}catch(t){}}persistStateGoogle(e,o){try{window.localStorage.setItem(this.GOOGLE_STATE_KEY,JSON.stringify({accessToken:e,idToken:o}))}catch(t){console.error("Cannot persist state google",t)}}clearStateGoogle(){try{window.localStorage.removeItem(this.GOOGLE_STATE_KEY)}catch(e){console.error("Cannot clear state google",e)}}getGoogleState(){try{const e=window.localStorage.getItem(this.GOOGLE_STATE_KEY);if(!e)return null;const{accessToken:o,idToken:t}=JSON.parse(e);return{accessToken:o,idToken:t}}catch(e){return console.error("Cannot get state google",e),null}}async traditionalOAuth({scopes:e,hostedDomain:t,nonce:i}){const n=[...new Set([...e||[],"openid"])],r=new URLSearchParams(Object.assign(Object.assign({client_id:this.clientId,redirect_uri:this.redirectUrl||window.location.origin+window.location.pathname,response_type:"offline"===this.loginType?"code":"token id_token",scope:n.join(" ")},i&&{nonce:i}),{include_granted_scopes:"true",state:"popup"}));void 0!==t&&r.append("hd",t);const s=`https://accounts.google.com/o/oauth2/v2/auth?${r.toString()}`,a=window.screenX+(window.outerWidth-500)/2,l=window.screenY+(window.outerHeight-600)/2;localStorage.setItem(o.OAUTH_STATE_KEY,"true");const c=window.open(s,"Google Sign In",`width=500,height=600,left=${a},top=${l},popup=1`);let d,p;return new Promise(((e,o)=>{if(!c)return void o(new Error("Failed to open popup"));const t=o=>{var i,n,r;if(o.origin===window.location.origin&&!(null===(n=null===(i=o.data)||void 0===i?void 0:i.source)||void 0===n?void 0:n.startsWith("angular"))&&"oauth-response"===(null===(r=o.data)||void 0===r?void 0:r.type))if(window.removeEventListener("message",t),clearInterval(d),"online"===this.loginType){const{accessToken:t,idToken:i}=o.data;if(t&&i){const o=this.parseJwt(i);this.persistStateGoogle(t.token,i),e({provider:"google",result:{accessToken:{token:t.token},idToken:i,profile:{email:o.email||null,familyName:o.family_name||null,givenName:o.given_name||null,id:o.sub||null,name:o.name||null,imageUrl:o.picture||null},responseType:"online"}})}}else{const{serverAuthCode:t}=o.data;e({provider:"google",result:{responseType:"offline",serverAuthCode:t}})}};window.addEventListener("message",t),p=setTimeout((()=>{clearTimeout(p),window.removeEventListener("message",t),c.close(),o(new Error("OAuth timeout"))}),3e5),d=setInterval((()=>{c.closed&&(clearInterval(d),o(new Error("Popup closed")))}),1e3)}))}}class s extends t{constructor(){var e;if(super(),this.googleProvider=new r,this.appleProvider=new i,this.facebookProvider=new n,localStorage.getItem(s.OAUTH_STATE_KEY)){console.log("OAUTH_STATE_KEY found");const o=this.handleOAuthRedirect();o&&(null===(e=window.opener)||void 0===e||e.postMessage(Object.assign({type:"oauth-response"},o.result),window.location.origin),window.close())}}handleOAuthRedirect(){const e=new URL(window.location.href);return this.googleProvider.handleOAuthRedirect(e)}async initialize(e){var o,t,i;const n=[];(null===(o=e.google)||void 0===o?void 0:o.webClientId)&&n.push(this.googleProvider.initialize(e.google.webClientId,e.google.mode,e.google.hostedDomain,e.google.redirectUrl)),(null===(t=e.apple)||void 0===t?void 0:t.clientId)&&n.push(this.appleProvider.initialize(e.apple.clientId,e.apple.redirectUrl)),(null===(i=e.facebook)||void 0===i?void 0:i.appId)&&n.push(this.facebookProvider.initialize(e.facebook.appId)),await Promise.all(n)}async login(e){switch(e.provider){case"google":return this.googleProvider.login(e.options);case"apple":return this.appleProvider.login(e.options);case"facebook":return this.facebookProvider.login(e.options);default:throw new Error(`Login for ${e.provider} is not implemented on web`)}}async logout(e){switch(e.provider){case"google":return this.googleProvider.logout();case"apple":return this.appleProvider.logout();case"facebook":return this.facebookProvider.logout();default:throw new Error(`Logout for ${e.provider} is not implemented`)}}async isLoggedIn(e){switch(e.provider){case"google":return this.googleProvider.isLoggedIn();case"apple":return this.appleProvider.isLoggedIn();case"facebook":return this.facebookProvider.isLoggedIn();default:throw new Error(`isLoggedIn for ${e.provider} is not implemented`)}}async getAuthorizationCode(e){switch(e.provider){case"google":return this.googleProvider.getAuthorizationCode();case"apple":return this.appleProvider.getAuthorizationCode();case"facebook":return this.facebookProvider.getAuthorizationCode();default:throw new Error(`getAuthorizationCode for ${e.provider} is not implemented`)}}async refresh(e){switch(e.provider){case"google":return this.googleProvider.refresh();case"apple":return this.appleProvider.refresh();case"facebook":return this.facebookProvider.refresh(e.options);default:throw new Error(`Refresh for ${e.provider} is not implemented`)}}}e("SocialLoginWeb",s),s.OAUTH_STATE_KEY="social_login_oauth_pending"}}}));
